<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>CS480X Homework 4</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <style>
        /*div.tooltip {*/
        /*    position: absolute;*/
        /*    text-align: center;*/
        /*    width: 80px;*/
        /*    height: 30px;*/
        /*    padding: 2px;*/
        /*    font: 12px sans-serif;*/
        /*    background: #fff;*/
        /*    border: 0px;*/
        /*    pointer-events: none;}*/

        /*#BG {*/
        /*    width: 1420px;*/
        /*    border: 1px solid black;*/
        /*    overflow: hidden; !* add this to contain floated children *!*/
        /*}*/
        /*#BG1 {*/
        /*    width: 1420px;*/
        /*    height: 825px;*/
        /*    border: 1px solid blueviolet;*/
        /*    overflow: hidden;*/
        /*}*/
        /*#BG2{*/
        /*    width: 1420px;*/
        /*    height: 800px;*/
        /*    border: 1px solid lavender;*/
        /*    overflow: hidden;*/
        /*}*/
        /*#BG3{*/
        /*    width: 1420px;*/
        /*    height: 600px;*/
        /*    border: 1px solid rosybrown;*/
        /*    overflow: hidden;*/
        /*}*/
    </style>
</head>
<body>
<div id="BG">
    <div id="BG1"></div>
    <div id="BG2"></div>
    <div id="BG3"></div>
</div>
<script>
    // Choroth Map
    let widthMap = 675,
        heightMap = 425,
        marginMap = {top: 60, bottom: 40, left: 70, right: 40 };
    // The svg
    let svgMap = d3.select("#svgMap")
        .append("svg")
        .attr("id", "chart")
        .attr("width", widthMap)
        .attr("height", heightMap)
        .append("g")
        .attr("tranform", "translate(0" + marginMap.left + "," + marginMap.top + ")");

    // Map and projection
    let projection = d3.geoAlbersUsa()
        .translate([275 + marginMap.left, 150 + marginMap.top])
        .scale([800]);

    // Data and color scale
    var data = d3.map();
    var keys = [0, 10, 20, 30 , 40 , 50, 60, 70];
    var colorScale = d3.scaleThreshold()
        .domain(keys)
        .range(d3.schemeYlGnBu[8]);


    function computeMin(data) {
        var min = d3.min(data, function (d) {
            return d.value;
        });
        return min;
    }
    function computeMax(data) {
        var max = d3.max(data, function (d) {
            return d.value;
        });
        return max;
    }
    function computeMinMax(data) {
        var minmax = [computeMin(data), computeMax(data)];
        return minmax
    }

    function legendDots() {
        svgMap.selectAll("mycolors")
            .data(colorScale)
            .enter()
            .append("rect")
            .attr("x", widthMap - 100)
            .attr("y", function (d, i) { return heightMap - marginMap.bottom - marginMap.top - (1 - i) * 15 })
            .attr("width", 15)
            .attr("height", 15)
            .style("fill", function (d) { return d; })
            .style("stroke", "#000")
            .style("stroke-width", "0.5px");
    }
    function legendLabels(domain) {
        svgMap.selectAll("mydots")
            .data(domain)
            .enter()
            .append("text")
            .style("fill", "black")
            .style("font-size", "9px")
            .attr("x", widthMap - 80)
            .attr("y", function (d, i) { return heightMap - marginMap.bottom - marginMap.top + 3 - (1 - i) * 15 })
            .text(function (d) { return d.toFixed(4); });
    }
    function legend(data) {
        let min = computeMin(data);
        let max = computeMax(data);
        let domain = [min, min + (max - min) / 5, min + 2 * (max - min) / 5, min + 3 * (max - min) / 5, min + 4 * (max - min) / 5, max]
        legendDots();
        legendLabels(domain)
    };

    function mapChart(data) {
        let dataProcessed = new Array(52);
        dataProcessed =
            d3.json("us-states.json", function (json) {
                //Merge the agriculture and GeoJSON data
                //Loop through once for each agriculture data value
                for (var i = 0; i < data.length; i++) {
                    // grab state name
                    var dataState = data[i].state;
                    //grab data value, and convert from string to float
                    var dataValue = parseFloat(data[i].value);
                    //find the corresponding state inside the GeoJSON
                    let n = 0;
                    for (n = 0; n < json.features.length; n++) {
                        // properties name gets the states name
                        var jsonState = json.features[n].properties.name;
                        // if statment to merge by name of state
                        if (dataState == jsonState) {
                            //Copy the data value into the JSON
                            // basically creating a new value column in JSON data
                            json.features[n].properties.value = dataValue;
                            //stop looking through the JSON
                            break;
                        }
                    }
                }
                // process data, add alaska, hawaii, dc, and potorico

                for (var n = 0; n < json.features.length; n++){
                    if (json.features[n].properties.value == null){
                        json.features[n].properties.value = 'N/a';
                    }
                    let tempObj = {state: json.features[n].properties.name, value: json.features[n].properties.value};
                    dataProcessed[n] = tempObj;
                }
                mapCharthelper(data,json);
                console.log(dataProcessed);
                return(dataProcessed);
            });
        return(dataProcessed);
    }
    function mapCharthelper(data,json) {
        svgMap.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("stroke", "#000")
            .style("stroke-width", "0.5px")
            .style("fill", function (d) {
                //get the data value
                var value = d.properties.value;
                if (value) {
                    //If value exists
                    return color(value);
                } else {
                    // If value is undefined
                    //we do this because alaska and hawaii are not in dataset we are using but still in projections
                    return "#ccc"
                }
            })
            .attr("class", function(d,i) { return "pt" + i; })
            .attr("id", function(d) { return "mapChart"; })
            .style("opacity", .9)
            .on("mouseover", function(d, i){
                onMouseDimBar(true);
                onMouseDimMap(true);
                onMouseLightSelectedPt(true,i);
                tooltip
                    .style("opacity", 1);
                tooltip.html(d.properties.name + "<br>" + d.properties.value)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(d, i){
                onMouseDimBar(false);
                onMouseDimMap(false);
                onMouseLightSelectedPt(false,i);
                tooltip
                    .style("opacity", 0);
            });
    }

    function onMouseDimMap(b) {
        d3.selectAll("#mapChart")
            .transition()
            .style("opacity", (b) ? 0.7 : 0.9);
    }

    function onMouseLightSelectedPt(b,i) {
        d3.selectAll("path.pt" + i)
            .style("opacity", 1)
            .style("fill", (b) ?
                "#d01c8b" :
                function (d) {
                    if (d.properties.value) { return color(d.properties.value);
                    } else { return "#ccc" }
                });
        d3.selectAll("rect.pt" + i)
            .style("opacity", 1)
            .style("fill", (b) ?
                "#d01c8b" :
                function (d) {
                    if (d.value) { return color(d.value);
                    } else { return "#ccc" }
                });
        d3.selectAll("path.Piept" + i)
            .style("opacity", 1)
            .style("fill", (b) ?
                function (d) {
                    if (d.value) { return color(d.value);
                    } else { return "#ccc" }
                }
                : "#a06a72");
        d3.selectAll("text.txt" + i)
            .style("opacity", (b) ? 1 : 0);
    }
</script>
</body>
</html>

